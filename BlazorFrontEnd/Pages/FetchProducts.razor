@using Shared.Models
@using System.Text.Json
@page "/fetch"

<h3>Product List</h3>

<ul>
    @if (products != null)
    {
        foreach (var product in products)
        {
            <li>@product.Name - $@product.Price (@product.Stock in stock) </li>
        }
    }
    else if (errorMessage != null)
    {
        <li>@errorMessage</li>
    }
    else
    {
        <li>Loading...</li>
    }
</ul>

@code {
    private List<Product>? products;
    private string? errorMessage;
    private bool debugMode = false; // Set to true for debugging

    protected override async Task OnInitializedAsync()
    {
        try
        {
            using var httpClient = new HttpClient
            {
                Timeout = TimeSpan.FromSeconds(10) // Set a timeout for the request
            };

            var response = await httpClient.GetAsync("http://localhost:5035/api/products");

            if (!response.IsSuccessStatusCode)
            {
                // Handle non-success status codes (e.g., 404, 500)
                Console.WriteLine($"Error: {response.StatusCode} - {response.ReasonPhrase}");
                if (debugMode)
                    errorMessage = $"Error: Unable to fetch products (Status Code: {response.StatusCode})";
                return;
            }

            var jsonResponse = await response.Content.ReadAsStringAsync();
            if (string.IsNullOrWhiteSpace(jsonResponse))
            {
                // Handle empty response
                Console.WriteLine("Error: Empty response from the server.");
                if (debugMode)
                    errorMessage = "Error: Empty response from the server.";
                return;
            }

            products = JsonSerializer.Deserialize<List<Product>>(jsonResponse, new JsonSerializerOptions
            {
                PropertyNameCaseInsensitive = true // Handle case-insensitive property names
            });

            if (products == null)
            {
                // Handle the case where the response is empty or null
                Console.WriteLine("Error: No products found in the response.");
                if (debugMode)
                    errorMessage = "Error: No products found in the response.";
                return;
            }
        }
        catch (TaskCanceledException)
        {
            // Handle timeout exceptions
            Console.WriteLine("Error: The request timed out.");
            if (debugMode)
                errorMessage = "Error: The request timed out. Please try again later.";
            return;
        }
        catch (JsonException)
        {
            // Handle JSON parsing exceptions
            Console.WriteLine("Error: Failed to parse the product data.");
            if (debugMode)
                errorMessage = "Error: Failed to parse the product data.";
            return;
        }
        catch (Exception ex)
        {
            // Handle any other exceptions that may occur
            Console.WriteLine($"Error: An unexpected error occurred - {ex.Message}");
            if (debugMode)
                errorMessage = $"Error: An unexpected error occurred - {ex.Message}";
            return;
        }
    }
}